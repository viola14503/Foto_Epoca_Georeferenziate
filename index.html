<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <title>Case cantoniere</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Mapbox -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>

    <!-- PapaParse (CSV) -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        /* ✅ font base responsive */
        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            font-size: clamp(14px, 1.1vw, 18px);
        }

        #app {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        #sidebar {
            width: 360px;
            min-width: 240px;
            max-width: 520px;
            border-right: 1px solid #ddd;
            padding: 12px;
            overflow-y: auto;
            background: #fafafa;
        }

            #sidebar h2 {
                margin: 0 0 12px;
                font-weight: 800;
                line-height: 1.2;
                font-size: clamp(18px, 1.4vw, 24px);
            }

        .casa-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.15s;
            border: 1px solid #eee;
            background: #fff;
        }

            .casa-item:hover {
                background: #f0f0f0;
            }

            .casa-item strong {
                display: block;
                margin-bottom: 4px;
                font-size: clamp(14px, 1.05vw, 17px);
            }

            .casa-item small {
                color: #666;
                display: block;
                line-height: 1.3;
                font-size: clamp(12px, 0.95vw, 15px);
            }

        #map {
            flex: 1;
        }

        /* ✅ POPUP: grande (>= metà schermo) + scroll interno */
        .mapboxgl-popup-content {
            width: min(92vw, 1200px);
            max-width: 1200px;
            max-height: min(80vh, 780px);
            overflow: auto;
            padding: 16px 18px;
        }

        .popup-grid {
            display: grid;
            grid-template-columns: minmax(260px, 520px) 1fr;
            gap: 14px;
            align-items: start;
        }

        .popup-img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 10px;
        }

        .popup-title {
            font-weight: 900;
            margin: 0 0 10px;
            overflow-wrap: anywhere;
            line-height: 1.15;
            font-size: clamp(18px, 1.6vw, 26px);
        }

        .meta {
            overflow-wrap: anywhere;
            line-height: 1.55;
            font-size: clamp(14px, 1.15vw, 18px);
        }

            .meta .row {
                margin-top: 8px;
            }

            .meta b {
                font-weight: 800;
            }

        .muted {
            color: #666;
        }

        @media (max-width: 900px) {
            .mapboxgl-popup-content {
                width: 94vw;
            }

            .popup-grid {
                grid-template-columns: 1fr;
            }

            .popup-img {
                max-height: 45vh;
                object-fit: contain;
            }
        }

        /* Icona casa */
        .marker-casa {
            width: 28px;
            height: 28px;
            background-image: url("img/icon-casa.png");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="sidebar">
            <h2>Case cantoniere</h2>
            <div id="lista-case"></div>
        </div>
        <div id="map"></div>
    </div>

    <script>
        // 🔑 Token Mapbox
        mapboxgl.accessToken =
            "pk.eyJ1IjoidmlvbGExMCIsImEiOiJjbWk0YjU2eDkxNDFtMmtxd2Eza3RyZ2QwIn0.AjMPW13eUzC91eH1FHD0-g";

        // 📄 CSV esportato dal foglio FOTO_EPOCA_Selezionate
        const CSV_FILE = "FOTO_EPOCA_Selezionate.csv";

        // Vista iniziale: Lazio + limitrofi
        const map = new mapboxgl.Map({
            container: "map",
            style: "mapbox://styles/mapbox/light-v11",
            center: [12.7, 42.0],
            zoom: 6.8
        });

        const markersById = {};
        let records = [];

        // Escape HTML
        function esc(s) {
            return (s ?? "").toString()
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        // ✅ Parser coordinate robusto (DMS o decimali)
        function dmsToDecimalPair(coordStr) {
            if (!coordStr) return null;
            const s = coordStr.trim();

            // blocchi terminanti con N/S/E/W
            const parts = s.match(/[^NSEW]*[NSEW]/gi);
            if (parts && parts.length >= 2) {
                const a = parts[0].trim();
                const b = parts[1].trim();

                function parseOne(part) {
                    const hemi = (part.match(/[NSEW]/i) || [""])[0].toUpperCase();
                    const nums = part.match(/[-+]?\d+(?:[.,]\d+)?/g) || [];
                    const deg = nums[0] ? parseFloat(nums[0].replace(",", ".")) : 0;
                    const min = nums[1] ? parseFloat(nums[1].replace(",", ".")) : 0;
                    const sec = nums[2] ? parseFloat(nums[2].replace(",", ".")) : 0;
                    let val = deg + (min / 60) + (sec / 3600);
                    if (hemi === "S" || hemi === "W") val = -val;
                    return { hemi, val };
                }

                const p1 = parseOne(a);
                const p2 = parseOne(b);

                let lat = null, lon = null;

                if (p1.hemi === "N" || p1.hemi === "S") lat = p1.val;
                if (p1.hemi === "E" || p1.hemi === "W") lon = p1.val;

                if (p2.hemi === "N" || p2.hemi === "S") lat = p2.val;
                if (p2.hemi === "E" || p2.hemi === "W") lon = p2.val;

                if (lat !== null && lon !== null && isFinite(lat) && isFinite(lon)) {
                    return { lat, lon };
                }
            }

            // fallback: due numeri decimali
            const nums = s.match(/[-+]?\d+(?:[.,]\d+)?/g);
            if (nums && nums.length >= 2) {
                const a = parseFloat(nums[0].replace(",", "."));
                const b = parseFloat(nums[1].replace(",", "."));

                if (Math.abs(a) <= 90 && Math.abs(b) <= 180) return { lat: a, lon: b };
                if (Math.abs(b) <= 90 && Math.abs(a) <= 180) return { lat: b, lon: a };
            }

            return null;
        }

        // Popup (immagine sinistra, testo destra) — testo integrale, nessun taglio
        function buildPopupHtml(r) {
            const nome = (r["Nome"] ?? "").toString().trim();
            const imgSrc = `img/${encodeURIComponent(nome)}.bmp`;

            const titolo = (r["Titolo"] ?? "").toString();

            const data =
                (r["Data rilievo fotografico"] ??
                    r["Data del rilievo fotografico"] ??
                    r["Data rilievo fotografico "] ??
                    "").toString();

            const autore = (r["Autore"] ?? "").toString();

            const descr =
                (r["Descrizione su foto"] ??
                    r["Descrizione del contenuto"] ??
                    "").toString();

            const compartimento = (r["Compartimento"] ?? "").toString();
            const strada = (r["Strada"] ?? "").toString();
            const km = (r["Chilometrica"] ?? "").toString();

            const mapsUrl =
                (r["LINK"] ??
                    r["Link"] ??
                    r["Maps"] ??
                    r["Google Maps"] ??
                    "").toString();

            const coordLabel = (r["Coordinate per georeferenziazione"] ?? r["Coordinate"] ?? "").toString();

            const stradaKm = [strada, km].filter(Boolean).join(" – km ");

            return `
            <div class="popup-grid">
              <div>
                <img src="${imgSrc}" class="popup-img" alt="${esc(nome)}">
              </div>

              <div>
                <div class="popup-title"><b>${esc(titolo)}</b></div>

                <div class="meta">
                  ${data ? `<div class="row"><b>Data del rilievo fotografico:</b> ${esc(data)}</div>` : ""}
                  ${autore ? `<div class="row"><b>Autore:</b> ${esc(autore)}</div>` : ""}
                  ${descr ? `<div class="row"><b>Descrizione:</b> ${esc(descr)}</div>` : ""}
                  ${compartimento ? `<div class="row"><b>Compartimento:</b> ${esc(compartimento)}</div>` : ""}
                  ${stradaKm ? `<div class="row"><b>Strada:</b> ${esc(stradaKm)}</div>` : ""}
                  ${mapsUrl ? `<div class="row"><a href="${mapsUrl}" target="_blank" rel="noopener">Apri in Google Maps</a></div>` : ""}
                  ${coordLabel ? `<div class="row muted"><b>Coordinate:</b> ${esc(coordLabel)}</div>` : ""}
                </div>
              </div>
            </div>
          `;
        }

        // ✅ Caricamento CSV con fallback encoding (UTF-8 -> Windows-1252)
        async function loadCsvAndBuild() {
            const res = await fetch(CSV_FILE, { cache: "no-store" });
            const buf = await res.arrayBuffer();

            // prova UTF-8
            let text = new TextDecoder("utf-8").decode(buf);

            // se ci sono caratteri sostituzione, prova Windows-1252 (Excel ANSI)
            const bad = (text.match(/\uFFFD/g) || []).length;
            if (bad > 0) {
                text = new TextDecoder("windows-1252").decode(buf);
            }

            const parsed = Papa.parse(text, {
                header: true,
                skipEmptyLines: true
            });

            records = (parsed.data || []).filter(r => {
                const nome = (r["Nome"] ?? "").toString().trim();
                const titolo = (r["Titolo"] ?? "").toString().trim();
                const coord = (r["Coordinate per georeferenziazione"] ?? r["Coordinate"] ?? "").toString().trim();
                return nome && titolo && coord;
            });

            if (map.loaded()) buildMarkersAndList(records);
            else map.on("load", () => buildMarkersAndList(records));
        }

        function buildMarkersAndList(recs) {
            const lista = document.getElementById("lista-case");
            lista.innerHTML = "";

            // rimuovi vecchi markers
            Object.values(markersById).forEach(x => {
                try { x.marker.remove(); } catch (e) { }
            });
            for (const k in markersById) delete markersById[k];

            recs.forEach(r => {
                const nome = (r["Nome"] ?? "").toString().trim();
                const titolo = (r["Titolo"] ?? "").toString().trim();
                const coordStr = (r["Coordinate per georeferenziazione"] ?? r["Coordinate"] ?? "").toString().trim();

                const p = dmsToDecimalPair(coordStr);
                if (!p) {
                    console.warn("Coordinate non parseabili:", nome, coordStr);
                    return;
                }

                const coordinates = [p.lon, p.lat]; // Mapbox: [lon, lat]

                // sicurezza: se fuori range Italia, scarta e logga
                if (p.lat < 35 || p.lat > 48 || p.lon < 6 || p.lon > 19) {
                    console.warn("Coordinate fuori Italia:", nome, coordStr, p);
                    return;
                }

                const el = document.createElement("div");
                el.className = "marker-casa";

                const popup = new mapboxgl.Popup({ offset: 20 })
                    .setHTML(buildPopupHtml(r));

                const marker = new mapboxgl.Marker(el)
                    .setLngLat(coordinates)
                    .setPopup(popup)
                    .addTo(map);

                markersById[nome] = { marker, popup, coordinates, row: r };

                // Sidebar item
                const div = document.createElement("div");
                div.className = "casa-item";

                const strada = (r["Strada"] ?? "").toString().trim();
                const km = (r["Chilometrica"] ?? "").toString().trim();
                const compartimento = (r["Compartimento"] ?? "").toString().trim();
                const data =
                    (r["Data rilievo fotografico"] ??
                        r["Data del rilievo fotografico"] ??
                        r["Data rilievo fotografico "] ??
                        "").toString().trim();

                const sub1 = [strada, km ? `km ${km}` : ""].filter(Boolean).join(" – ");
                const sub2 = compartimento ? `Compartimento: ${compartimento}` : "";
                const sub3 = data ? `Data: ${data}` : "";

                div.innerHTML = `
              <strong>${esc(titolo)}</strong>
              ${sub1 ? `<small>${esc(sub1)}</small>` : ""}
              ${sub2 ? `<small>${esc(sub2)}</small>` : ""}
              ${sub3 ? `<small>${esc(sub3)}</small>` : ""}
            `;

                div.addEventListener("click", () => {
                    map.flyTo({ center: coordinates, zoom: 12.5, essential: true });
                    markersById[nome].popup.setHTML(buildPopupHtml(r)).addTo(map);
                });

                lista.appendChild(div);
            });
        }

        loadCsvAndBuild();
    </script>
</body>
</html>
