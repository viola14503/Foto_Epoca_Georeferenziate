<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <title>Case cantoniere</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Mapbox -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>

    <!-- PapaParse (CSV) -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            font-size: clamp(13px, 1.0vw, 16px);
        }

        #app {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        #sidebar {
            width: 360px;
            min-width: 240px;
            max-width: 520px;
            border-right: 1px solid #ddd;
            padding: 12px;
            overflow-y: auto;
            background: #fafafa;
        }

            #sidebar h2 {
                margin: 0 0 12px;
                font-weight: 800;
                line-height: 1.2;
                font-size: clamp(16px, 1.25vw, 20px);
            }

        .casa-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.15s;
            border: 1px solid #eee;
            background: #fff;
        }

            .casa-item:hover {
                background: #f0f0f0;
            }

            .casa-item strong {
                display: block;
                margin-bottom: 4px;
                font-size: clamp(13px, 1.0vw, 15px);
            }

            .casa-item small {
                color: #666;
                display: block;
                line-height: 1.3;
                font-size: clamp(11.5px, 0.9vw, 13.5px);
            }

        #map {
            flex: 1;
        }

        /* POPUP: grande + scroll interno */
        .mapboxgl-popup-content {
            width: min(92vw, 1200px);
            max-width: 1200px;
            max-height: min(80vh, 780px);
            overflow: auto;
            padding: 16px 18px;
        }

        .popup-title {
            font-weight: 900;
            margin: 0 0 10px;
            overflow-wrap: anywhere;
            line-height: 1.15;
            font-size: clamp(16px, 1.35vw, 22px);
        }

        .meta {
            overflow-wrap: anywhere;
            line-height: 1.55;
            font-size: clamp(13px, 1.0vw, 16px);
            margin-bottom: 12px;
        }

            .meta .row {
                margin-top: 8px;
            }

            .meta b {
                font-weight: 800;
            }

        .muted {
            color: #666;
        }

        /* Galleria immagini nel popup */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 10px;
            align-items: start;
        }

        .photo-card {
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 10px;
            background: #fff;
        }

            .photo-card img {
                width: 100%;
                height: auto;
                display: block;
                border-radius: 8px;
            }

        .photo-caption {
            margin-top: 8px;
            font-size: 13px;
            line-height: 1.35;
            overflow-wrap: anywhere;
        }

        .photo-links {
            margin-top: 6px;
            font-size: 13px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        @media (max-width: 900px) {
            .mapboxgl-popup-content {
                width: 94vw;
            }

            .gallery {
                grid-template-columns: 1fr;
            }
        }

        /* Icona casa */
        .marker-casa {
            width: 28px;
            height: 28px;
            background-image: url("img/icon-casa.png");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="sidebar">
            <h2>Case cantoniere</h2>
            <div id="lista-case"></div>
        </div>
        <div id="map"></div>
    </div>

    <script>
        mapboxgl.accessToken =
            "pk.eyJ1IjoidmlvbGExMCIsImEiOiJjbWk0YjU2eDkxNDFtMmtxd2Eza3RyZ2QwIn0.AjMPW13eUzC91eH1FHD0-g";

        const CSV_FILE = "FOTO_EPOCA_Selezionate.csv";

        const map = new mapboxgl.Map({
            container: "map",
            style: "mapbox://styles/mapbox/light-v11",
            center: [12.7, 42.0],
            zoom: 6.8
        });

        const markersByGroup = {}; // <— ora per gruppo (coordinate)
        let records = [];

        function esc(s) {
            return (s ?? "").toString()
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        function normalizeQuotes(str) {
            if (str == null) return "";
            let s = str.toString();
            s = s.replace(/[“”]/g, '"').replace(/[‘’]/g, "'");
            s = s.replace(/"([^"]+)"/g, "“$1”");
            s = s.replace(/'([^']+)'/g, "‘$1’");
            return s;
        }

        function cleanText(str) { return normalizeQuotes(str); }

        // Parser coordinate robusto (DMS o decimali)
        function dmsToDecimalPair(coordStr) {
            if (!coordStr) return null;
            const s = coordStr.trim();

            const parts = s.match(/[^NSEW]*[NSEW]/gi);
            if (parts && parts.length >= 2) {
                const a = parts[0].trim();
                const b = parts[1].trim();

                function parseOne(part) {
                    const hemi = (part.match(/[NSEW]/i) || [""])[0].toUpperCase();
                    const nums = part.match(/[-+]?\d+(?:[.,]\d+)?/g) || [];
                    const deg = nums[0] ? parseFloat(nums[0].replace(",", ".")) : 0;
                    const min = nums[1] ? parseFloat(nums[1].replace(",", ".")) : 0;
                    const sec = nums[2] ? parseFloat(nums[2].replace(",", ".")) : 0;
                    let val = deg + (min / 60) + (sec / 3600);
                    if (hemi === "S" || hemi === "W") val = -val;
                    return { hemi, val };
                }

                const p1 = parseOne(a);
                const p2 = parseOne(b);

                let lat = null, lon = null;

                if (p1.hemi === "N" || p1.hemi === "S") lat = p1.val;
                if (p1.hemi === "E" || p1.hemi === "W") lon = p1.val;

                if (p2.hemi === "N" || p2.hemi === "S") lat = p2.val;
                if (p2.hemi === "E" || p2.hemi === "W") lon = p2.val;

                if (lat !== null && lon !== null && isFinite(lat) && isFinite(lon)) {
                    return { lat, lon };
                }
            }

            const nums = s.match(/[-+]?\d+(?:[.,]\d+)?/g);
            if (nums && nums.length >= 2) {
                const a = parseFloat(nums[0].replace(",", "."));
                const b = parseFloat(nums[1].replace(",", "."));
                if (Math.abs(a) <= 90 && Math.abs(b) <= 180) return { lat: a, lon: b };
                if (Math.abs(b) <= 90 && Math.abs(a) <= 180) return { lat: b, lon: a };
            }

            return null;
        }

        // chiave gruppo: arrotonda per evitare micro-differenze
        function coordKey(lat, lon, decimals = 5) {
            const f = Math.pow(10, decimals);
            const rLat = Math.round(lat * f) / f;
            const rLon = Math.round(lon * f) / f;
            return `${rLat.toFixed(decimals)},${rLon.toFixed(decimals)}`;
        }

        // helper: trova un valore da possibili intestazioni (CSV “variabile”)
        function pick(r, keys) {
            for (const k of keys) {
                if (r[k] != null && String(r[k]).trim() !== "") return String(r[k]);
            }
            return "";
        }

        // ✅ Raggruppa per coordinate (1 marker/popup per punto)
        function groupByCoordinates(recs) {
            const groups = new Map();

            for (const r of recs) {
                const nome = pick(r, ["Nome"]).trim();
                const titolo = cleanText(pick(r, ["Titolo"])).trim();

                // NEL TUO CSV la colonna sembra chiamarsi "Coordinat" / "Coordinat..." (tagliata in foto)
                // qui gestisco sia quella sia i nomi usati prima
                const coordStr = pick(r, [
                    "Coordinate per georeferenziazione",
                    "Coordinate",
                    "Coordinat",
                    "Coordinate per georeferenziazione "
                ]).trim();

                if (!nome || !titolo || !coordStr) continue;

                const p = dmsToDecimalPair(coordStr);
                if (!p) {
                    console.warn("Coordinate non parseabili:", nome, coordStr);
                    continue;
                }

                // scarto fuori Italia (come facevi tu)
                if (p.lat < 35 || p.lat > 48 || p.lon < 6 || p.lon > 19) {
                    console.warn("Coordinate fuori Italia:", nome, coordStr, p);
                    continue;
                }

                const key = coordKey(p.lat, p.lon, 5);

                if (!groups.has(key)) {
                    // prendo “info comune” dalla prima riga del gruppo
                    groups.set(key, {
                        key,
                        lat: p.lat,
                        lon: p.lon,
                        coordLabel: cleanText(coordStr),

                        // info pannello (dalla prima riga)
                        titolo: cleanText(pick(r, ["Titolo"])).trim(),
                        data: cleanText(pick(r, [
                            "Data rilievo fotografico",
                            "Data del rilievo fotografico",
                            "Data rilievo fotografico "
                        ])).trim(),
                        autore: cleanText(pick(r, ["Autore"])).trim(),
                        descr: cleanText(pick(r, [
                            "Descrizione su foto",
                            "Descrizione del contenuto",
                            "Descrizion",
                            "Descrizione"
                        ])).trim(),
                        compartimento: cleanText(pick(r, ["Compartimento", "Compartim"])).trim(),
                        strada: cleanText(pick(r, ["Strada"])).trim(),
                        km: cleanText(pick(r, ["Chilometrica", "Chilometr", "Chilomet"])).trim(),

                        // tutte le foto dello stesso punto
                        items: []
                    });
                }

                const g = groups.get(key);

                // link: nel tuo CSV è tipo "Link a goo..." / "Link a go..."
                const mapsUrl = pick(r, [
                    "LINK", "Link", "Maps", "Google Maps",
                    "Link a goo", "Link a go", "Link a goo.", "Link a goo…"
                ]).trim();

                g.items.push({
                    nome: nome,
                    titoloFoto: cleanText(pick(r, ["Titolo"])).trim(),
                    mapsUrl: mapsUrl
                });
            }

            return [...groups.values()];
        }

        // ✅ Popup: info comune + galleria foto (una per riga originale)
        function buildPopupHtmlGroup(g) {
            const stradaKm = [g.strada, g.km ? `km ${g.km}` : ""].filter(Boolean).join(" – ");

            const info = `
            <div class="popup-title"><b>${esc(g.titolo || "Senza titolo")}</b></div>
            <div class="meta">
              ${g.data ? `<div class="row"><b>Data del rilievo fotografico:</b> ${esc(g.data)}</div>` : ""}
              ${g.autore ? `<div class="row"><b>Autore:</b> ${esc(g.autore)}</div>` : ""}
              ${g.descr ? `<div class="row"><b>Descrizione:</b> ${esc(g.descr)}</div>` : ""}
              ${g.compartimento ? `<div class="row"><b>Compartimento:</b> ${esc(g.compartimento)}</div>` : ""}
              ${stradaKm ? `<div class="row"><b>Strada:</b> ${esc(stradaKm)}</div>` : ""}
              <div class="row muted"><b>Coordinate:</b> ${esc(g.coordLabel)}</div>
              <div class="row"><b>Foto nello stesso punto:</b> ${g.items.length}</div>
            </div>
          `;

            const gallery = `
            <div class="gallery">
              ${g.items.map((it, idx) => {
                const imgSrc = `img/${encodeURIComponent(it.nome)}.bmp`;
                const linkHtml = it.mapsUrl
                    ? `<a href="${esc(it.mapsUrl)}" target="_blank" rel="noopener">Apri in Google Maps</a>`
                    : "";
                return `
                  <div class="photo-card">
                    <img src="${imgSrc}" alt="${esc(it.nome)}">
                    <div class="photo-caption">
                      <b>${esc(it.nome)}</b>${it.titoloFoto ? ` — ${esc(it.titoloFoto)}` : ""}
                    </div>
                    ${linkHtml ? `<div class="photo-links">${linkHtml}</div>` : ""}
                  </div>
                `;
            }).join("")}
            </div>
          `;

            return `${info}${gallery}`;
        }

        // Caricamento CSV con fallback encoding
        async function loadCsvAndBuild() {
            const res = await fetch(CSV_FILE, { cache: "no-store" });
            const buf = await res.arrayBuffer();

            let text = new TextDecoder("utf-8").decode(buf);
            const bad = (text.match(/\uFFFD/g) || []).length;
            if (bad > 0) text = new TextDecoder("windows-1252").decode(buf);

            const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });

            // filtro minimo: Nome, Titolo, Coordinate
            records = (parsed.data || []).filter(r => {
                const nome = pick(r, ["Nome"]).trim();
                const titolo = pick(r, ["Titolo"]).trim();
                const coord = pick(r, [
                    "Coordinate per georeferenziazione",
                    "Coordinate",
                    "Coordinat",
                    "Coordinate per georeferenziazione "
                ]).trim();
                return nome && titolo && coord;
            });

            if (map.loaded()) buildMarkersAndList(records);
            else map.on("load", () => buildMarkersAndList(records));
        }

        function buildMarkersAndList(recs) {
            const lista = document.getElementById("lista-case");
            lista.innerHTML = "";

            // rimuovi vecchi markers
            Object.values(markersByGroup).forEach(x => {
                try { x.marker.remove(); } catch (e) { }
            });
            for (const k in markersByGroup) delete markersByGroup[k];

            const groups = groupByCoordinates(recs);

            groups.forEach(g => {
                const coordinates = [g.lon, g.lat];

                const el = document.createElement("div");
                el.className = "marker-casa";

                const popup = new mapboxgl.Popup({ offset: 20 })
                    .setHTML(buildPopupHtmlGroup(g));

                const marker = new mapboxgl.Marker(el)
                    .setLngLat(coordinates)
                    .setPopup(popup)
                    .addTo(map);

                markersByGroup[g.key] = { marker, popup, coordinates, group: g };

                // Sidebar item (1 per gruppo)
                const div = document.createElement("div");
                div.className = "casa-item";

                const sub1 = [g.strada, g.km ? `km ${g.km}` : ""].filter(Boolean).join(" – ");
                const sub2 = g.compartimento ? `Compartimento: ${g.compartimento}` : "";
                const sub3 = g.data ? `Data: ${g.data}` : "";
                const sub4 = `Foto: ${g.items.length}`;

                div.innerHTML = `
              <strong>${esc(g.titolo || "Senza titolo")}</strong>
              ${sub1 ? `<small>${esc(sub1)}</small>` : ""}
              ${sub2 ? `<small>${esc(sub2)}</small>` : ""}
              ${sub3 ? `<small>${esc(sub3)}</small>` : ""}
              <small>${esc(sub4)}</small>
            `;

                div.addEventListener("click", () => {
                    map.flyTo({ center: coordinates, zoom: 12.5, essential: true });
                    markersByGroup[g.key].popup
                        .setHTML(buildPopupHtmlGroup(g))
                        .addTo(map);
                });

                lista.appendChild(div);
            });
        }

        loadCsvAndBuild();
    </script>
</body>
</html>
