<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <title>Case cantoniere</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Mapbox -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>

    <!-- PapaParse (per leggere il CSV in modo robusto) -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        #app {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        #sidebar {
            width: 360px;
            min-width: 240px;
            max-width: 520px;
            border-right: 1px solid #ddd;
            padding: 12px;
            overflow-y: auto;
            background: #fafafa;
        }

            #sidebar h2 {
                margin: 0 0 12px;
                font-size: 20px;
                font-weight: 800;
                line-height: 1.2;
            }

        .casa-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.15s;
            border: 1px solid #eee;
            background: #fff;
        }

            .casa-item:hover {
                background: #f0f0f0;
            }

            .casa-item strong {
                display: block;
                font-size: 14px;
                margin-bottom: 4px;
            }

            .casa-item small {
                font-size: 12px;
                color: #666;
                display: block;
                line-height: 1.3;
            }

        #map {
            flex: 1;
        }

        /* ✅ POPUP: grande + almeno metà schermo */
        .mapboxgl-popup-content {
            width: min(92vw, 1200px);
            max-width: 1200px;
        }

        .popup-grid {
            display: grid;
            grid-template-columns: minmax(320px, 520px) 1fr;
            gap: 14px;
            align-items: start;
        }

        @media (max-width: 900px) {
            .popup-grid {
                grid-template-columns: 1fr;
            }
        }

        .popup-img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 10px;
        }

        .popup-title {
            font-size: 18px;
            font-weight: 900;
            margin: 0 0 10px;
            overflow-wrap: anywhere;
        }

        .meta {
            font-size: 14px;
            line-height: 1.5;
            overflow-wrap: anywhere;
        }

            .meta .row {
                margin-top: 8px;
            }

            .meta b {
                font-weight: 800;
            }

        .muted {
            color: #666;
        }

        /* Icona casa */
        .marker-casa {
            width: 28px;
            height: 28px;
            background-image: url("img/icon-casa.png");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="sidebar">
            <h2>Case cantoniere</h2>
            <div id="lista-case"></div>
        </div>
        <div id="map"></div>
    </div>

    <script>
    // 🔑 TOKEN MAPBOX
    mapboxgl.accessToken =
      "pk.eyJ1IjoidmlvbGExMCIsImEiOiJjbWk0YjU2eDkxNDFtMmtxd2Eza3RyZ2QwIn0.AjMPW13eUzC91eH1FHD0-g";

    // 📄 Nome CSV esportato dal foglio FOTO_EPOCA_Selezionate
    const CSV_FILE = "FOTO_EPOCA_Selezionate.csv";

    // Vista iniziale: Lazio + limitrofi
    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/light-v11",
      center: [12.7, 42.0],
      zoom: 6.8
    });

    const markersById = {};
    let records = [];

    // -------------------------
    // Utils: escape HTML
    // -------------------------
    function esc(s) {
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // -------------------------
    // Utils: DMS -> decimali
    // Accetta:
    // - "43°02'51.1\"N 12°54'24.3\"E"
    // - "43.0475 12.9067"
    // - "43.0475,12.9067"
    // -------------------------
    function dmsToDecimalPair(coordStr) {
      if (!coordStr) return null;
      const s = coordStr.trim();

      // Decimali semplici
      if (!s.includes("°")) {
        const nums = s.match(/[-+]?\d+(?:[.,]\d+)?/g);
        if (nums && nums.length >= 2) {
          const lat = parseFloat(nums[0].replace(",", "."));
          const lon = parseFloat(nums[1].replace(",", "."));
          if (isFinite(lat) && isFinite(lon)) return { lat, lon };
        }
      }

      function parseOne(part) {
        const hemiMatch = part.match(/[NSEW]/i);
        const hemi = hemiMatch ? hemiMatch[0].toUpperCase() : "";
        const nums = part.match(/[-+]?\d+(?:[.,]\d+)?/g) || [];
        const deg = nums[0] ? parseFloat(nums[0].replace(",", ".")) : 0;
        const min = nums[1] ? parseFloat(nums[1].replace(",", ".")) : 0;
        const sec = nums[2] ? parseFloat(nums[2].replace(",", ".")) : 0;
        let val = deg + (min/60) + (sec/3600);
        if (hemi === "S" || hemi === "W") val = -val;
        return val;
      }

      // Split lat e lon cercando N/S
      const ns = s.match(/(.+?[NS])/i);
      if (!ns) return null;
      const latPart = ns[1];
      const lonPart = s.slice(ns[1].length).trim();

      const lat = parseOne(latPart);
      const lon = parseOne(lonPart);

      if (!isFinite(lat) || !isFinite(lon)) return null;
      return { lat, lon };
    }

    // -------------------------
    // Popup HTML (testo integrale, nessun taglio)
    // -------------------------
    function buildPopupHtml(r) {
      // immagini .bmp nella cartella img/
      const nome = (r["Nome"] ?? "").trim();
      const imgSrc = `img/${encodeURIComponent(nome)}.bmp`;

      // colonne (devono corrispondere al tuo CSV)
      const titolo = (r["Titolo"] ?? "").toString();
      const data = (r["Data rilievo fotografico"] ?? r["Data rilievo fotografico "] ?? r["Data del rilievo fotografico"] ?? "").toString();
      const autore = (r["Autore"] ?? "").toString();
      const descr = (r["Descrizione su foto"] ?? r["Descrizione del contenuto"] ?? "").toString();
      const compartimento = (r["Compartimento"] ?? "").toString();
      const strada = (r["Strada"] ?? "").toString();
      const km = (r["Chilometrica"] ?? "").toString();
      const mapsUrl = (r["Link"] ?? r["LINK"] ?? r["Maps"] ?? "").toString();

      const stradaKm = [strada, km].filter(Boolean).join(" – km ");

      return `
        <div class="popup-grid">
          <div>
            <img src="${imgSrc}" class="popup-img" alt="${esc(nome)}">
          </div>

          <div>
            <div class="popup-title"><b>${esc(titolo)}</b></div>

            <div class="meta">
              ${data ? `<div class="row"><b>Data del rilievo fotografico:</b> ${esc(data)}</div>` : ""}
              ${autore ? `<div class="row"><b>Autore:</b> ${esc(autore)}</div>` : ""}
              ${descr ? `<div class="row"><b>Descrizione:</b> ${esc(descr)}</div>` : ""}
              ${compartimento ? `<div class="row"><b>Compartimento:</b> ${esc(compartimento)}</div>` : ""}
              ${stradaKm ? `<div class="row"><b>Strada:</b> ${esc(stradaKm)}</div>` : ""}
              ${mapsUrl ? `<div class="row"><a href="${mapsUrl}" target="_blank" rel="noopener">Apri in Google Maps</a></div>` : ""}
              <div class="row muted"><b>Coordinate:</b> ${esc((r["Coordinate per georeferenziazione"] ?? r["Coordinate"] ?? "").toString())}</div>
            </div>
          </div>
        </div>
      `;
    }

    // -------------------------
    // Carica CSV e crea markers/lista
    // -------------------------
    function loadCsvAndBuild() {
      Papa.parse(CSV_FILE, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (res) => {
          records = (res.data || []).filter(r => {
            const nome = (r["Nome"] ?? "").toString().trim();
            const titolo = (r["Titolo"] ?? "").toString().trim();
            const coord = (r["Coordinate per georeferenziazione"] ?? r["Coordinate"] ?? "").toString().trim();
            return nome && titolo && coord;
          });

          map.on("load", () => {
            buildMarkersAndList(records);
          });

          // se la mappa ha già fatto load
          if (map.loaded()) buildMarkersAndList(records);
        }
      });
    }

    function buildMarkersAndList(recs) {
      const lista = document.getElementById("lista-case");
      lista.innerHTML = "";

      // pulizia markers precedenti
      Object.values(markersById).forEach(x => {
        try { x.marker.remove(); } catch(e){}
      });

      recs.forEach((r, idx) => {
        const nome = (r["Nome"] ?? "").toString().trim();
        const titolo = (r["Titolo"] ?? "").toString().trim();
        const coordStr = (r["Coordinate per georeferenziazione"] ?? r["Coordinate"] ?? "").toString().trim();
        const p = dmsToDecimalPair(coordStr);
        if (!p) return;

        // Mapbox vuole [lon, lat]
        const coordinates = [p.lon, p.lat];

        const el = document.createElement("div");
        el.className = "marker-casa";

        const popup = new mapboxgl.Popup({ offset: 20 })
          .setHTML(buildPopupHtml(r));

        const marker = new mapboxgl.Marker(el)
          .setLngLat(coordinates)
          .setPopup(popup)
          .addTo(map);

        markersById[nome] = { marker, popup, coordinates, row: r };

        // Lista laterale
        const div = document.createElement("div");
        div.className = "casa-item";

        const strada = (r["Strada"] ?? "").toString().trim();
        const km = (r["Chilometrica"] ?? "").toString().trim();
        const compartimento = (r["Compartimento"] ?? "").toString().trim();
        const data = (r["Data rilievo fotografico"] ?? r["Data rilievo fotografico "] ?? "").toString().trim();

        const sub1 = [strada, km ? `km ${km}` : ""].filter(Boolean).join(" – ");
        const sub2 = compartimento ? `Compartimento: ${compartimento}` : "";
        const sub3 = data ? `Data: ${data}` : "";

        div.innerHTML = `
          <strong>${esc(titolo)}</strong>
          ${sub1 ? `<small>${esc(sub1)}</small>` : ""}
          ${sub2 ? `<small>${esc(sub2)}</small>` : ""}
          ${sub3 ? `<small>${esc(sub3)}</small>` : ""}
        `;

        div.addEventListener("click", () => {
          map.flyTo({ center: coordinates, zoom: 12.5, essential: true });
          markersById[nome].popup.setHTML(buildPopupHtml(r)).addTo(map);
        });

        lista.appendChild(div);
      });
    }

    loadCsvAndBuild();
    </script>
</body>
</html>
